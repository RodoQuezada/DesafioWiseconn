'use strict';
var crypto = require('crypto');
var uuid = require('./BHSAPHK').uuid;
var inherits = require('util').inherits;
var EventEmitter = require('events').EventEmitter;

function BridgeSetupSession(stateChar, controlChar) {
  this.validSession = false
  this.sessionUUID = uuid.generate(crypto.randomBytes(32));
  this.stateChar = stateChar;
  this.controlChar = controlChar;
  this.transactionID = 0;
  this.preferedLanguage = "en-US";
  this.lastResponse = null;
  this.currentStage = 0;
  this.currentPluginName;
  this.currentPlatformInstance;
  this.currentPlatformContext = {};
}

inherits(BridgeSetupSession, EventEmitter);

BridgeSetupSession.prototype.handleWriteRequest = function(request) {
  if (request.type === "Negotiate") {
    this.transactionID = request.tid + 1;
    this.preferedLanguage = request.language;
    this.validSession = true

    var respDict = {
      "tid": this.transactionID,
      "type": "Negotiate",
      "sid": this.sessionUUID,
      "attachment": {
        "type": "Interface",
        "interface": "list",
        "title": "How can I help you?",
        "items": [
          "Manage Platform",
          "Manage Accessories"
        ]
      }
    }

    this.currentStage = 1;

    this.sendResponse(respDict);
  } else if (request.type === "Interface") {
    this.transactionID = request.tid;

    if (this.currentStage === 1) {
      if (request.response.selections[0] === 0) {
        this.presentManagePlatformMenu();
      } else if (request.response.selections[0] === 1) {
        this.presentManageAccessoryMenu();
      }
    } else if (this.currentStage === 2) {
      var selectedIndex = request.response.selections[0];
      var targetPlatformName = this.listOfPlatforms[selectedIndex];
      var targetPlatform = this.configurablePlatformPlugins[targetPlatformName];

      this.currentPlatformContext = {};
      this.currentPlatformContext.preferedLanguage = this.preferedLanguage;
      this.currentPluginName = targetPlatformName;
      this.currentPlatformInstance = targetPlatform;
      this.currentStage = 3;
      this.currentPlatformInstance.configurationRequestHandler(this.currentPlatformContext, null, this.pluginResponseHandler.bind(this));
    } else if (this.currentStage === 3) {
      this.currentPlatformInstance.configurationRequestHandler(this.currentPlatformContext, request, this.pluginResponseHandler.bind(this));
    } else if (this.currentStage === 4) {
      this.handleManageAccessory(request);
    }
  } else if (request.type === "Terminate") {
    this.transactionID = request.tid;
    this.validSession = false;

    if (this.currentStage === 3) {
      this.currentPlatformInstance.configurationRequestHandler(this.currentPlatformContext, request, this.pluginResponseHandler.bind(this));
    }
  }
}

BridgeSetupSession.prototype.pluginResponseHandler = function(response, type, replace, config) {
  if (config) {
    this.emit('newConfig', type, this.currentPluginName, replace, config);
    this.presentMainMenu();
  } else if (response) {
    this.transactionID += 1;
    response.tid = this.transactionID;
    response.sid = this.sessionUUID;

    this.sendResponse(response);
  }
}

BridgeSetupSession.prototype.presentMainMenu = function() {
  this.currentStage = 1;

  this.transactionID += 1;

  var respDict = {
    "tid": this.transactionID,
    "sid": this.sessionUUID,
    "type": "Interface",
    "interface": "list",
    "title": "How can I help you?",
    "items": [
      "Manage Platform",
      "Manage Accessories"
    ]
  }

  this.sendResponse(respDict);
}

BridgeSetupSession.prototype.presentManagePlatformMenu = function() {
  var listOfPlatforms = [];
  for (var name in this.configurablePlatformPlugins) {
    listOfPlatforms.push(name);
  }
  this.listOfPlatforms = listOfPlatforms;

  this.transactionID += 1;

  var respDict = {
    "tid": this.transactionID,
    "type": "Interface",
    "sid": this.sessionUUID,
    "interface": "list",
    "title": "Which platform?",
    "items": listOfPlatforms
  }

  this.currentStage = 2;

  this.sendResponse(respDict);
}

BridgeSetupSession.prototype.presentManageAccessoryMenu = function() {
  this.emit('requestCurrentConfig', function(config) {
    this.currentConfig = config;
  }.bind(this));

  this.transactionID += 1;

  var respDict = {
    "tid": this.transactionID,
    "type": "Interface",
    "sid": this.sessionUUID,
    "interface": "instruction",
    "title": "Not Implemented",
    "detail": "This function is not yet implemented.\nPlease manually edit server.json for now.",
    "showNextButton": true,
    "heroImage": "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"
  }

  this.currentStage = 4;
  this.sendResponse(respDict);
}

BridgeSetupSession.prototype.handleManageAccessory = function(request) {
  this.presentMainMenu();
}

BridgeSetupSession.prototype.sendResponse = function(response) {
  if (this.validSession) {
    var serializedReponse = JSON.stringify(response);
    var respData = new Buffer(serializedReponse).toString('base64');
    this.lastResponse = respData;
    setTimeout(function() {
      this.controlChar.setValue(respData);
    }.bind(this), 100);
  }
}

BridgeSetupSession.prototype.handleReadRequest = function(callback) {
  callback(null, this.lastResponse);
}

module.exports = {
  SetupSession: BridgeSetupSession
};